
# การวิเคราะห์และสร้างพอร์ตการลงทุนตามหลัก Modern Portfolio Theory (MPT) และการใช้ XGBoost โดยพิจารณาปัจจัย ESG
---

## โปรเจกต์นี้คืออะไร?

โปรเจกต์นี้นำเสนอการทดลองสร้างพอร์ตการลงทุนเชิงยั่งยืน (ESG) ด้วย **สองแนวทางหลัก** เพื่อเปรียบเทียบประสิทธิภาพบนข้อมูลตลาดหุ้นไทย:

1. **วิธีแบบดั้งเดิม (Modern Portfolio Theory + ESG)**  
   - ยึดหลัก “อย่าใส่ไข่ไว้ในตะกร้าใบเดียว” (Diversification)  
   - คำนวณสัดส่วนการลงทุนที่เหมาะสมโดยอาศัยประวัติผลตอบแทนและความผันผวนของหุ้นที่ได้รับคะแนน ESG ตามเกณฑ์  
   - วิเคราะห์ว่าการเพิ่มเงื่อนไข ESG ช่วยลดความเสี่ยงและปรับปรุงผลตอบแทนอย่างไร  

2. **เทคโนโลยี AI (XGBoost + ESG)**  
   - ใช้โมเดล XGBoost ทำนายว่าหุ้นตัวใดมีโอกาสปรับตัวขึ้นในเดือนถัดไป จากสัญญาณเชิงเทคนิคและคะแนน ESG  
   - คัดเลือกเฉพาะหุ้นที่ AI ทำนายว่าจะให้ผลตอบแทนล่วงหน้า  
   - ตรวจสอบว่าการใช้ AI ร่วมกับเงื่อนไข ESG สามารถสร้างพอร์ตที่ยั่งยืนและให้ผลตอบแทนเหนือกว่า MPT แบบดั้งเดิมหรือไม่  

ทั้งสองแนวทางจะถูกทดสอบบนข้อมูล **“ข้อมูลราคาหุ้นย้อนหลังของตลาดหุ้นไทย”** ประกอบกับ **ข้อมูลคะแนน ESG** เพื่อประเมินผลในช่วงต่าง ๆ ของการทดลอง

---

## วัตถุประสงค์

1. **เปรียบเทียบประสิทธิภาพพอร์ต** ระหว่าง MPT + ESG กับ XGBoost + ESG  
2. **ประเมินผลกระทบของ ESG** ต่อความเสี่ยง (Risk) และผลตอบแทน (Return) ของพอร์ต  
3. **วิเคราะห์จุดแข็งและจุดอ่อน** ของการใช้ AI (XGBoost) ในการคัดเลือกหุ้นเชิง ESG  
4. **นำเสนอข้อค้นพบ** ที่สามารถนำไปปรับใช้ในกลยุทธ์ลงทุนเชิงธุรกิจได้จริง  

---

## ข้อมูลและช่วงเวลาการทดลอง

### ข้อมูลที่ใช้
- **ข้อมูลคะแนน ESG**:  
  - แหล่งที่มา: SET ESG Ratings (ดาวน์โหลดจาก [setsustainability.com](https://setsustainability.com/libraries/1258/item/set-esg-ratings))  
- **ข้อมูลราคาหุ้นย้อนหลัง**:  
  - แหล่งที่มา: ดึงผ่าน `yfinance` จาก Yahoo Finance  

### ช่วงเวลาทดสอบ
- **In-Sample (Train)**: มกราคม 2021 – ธันวาคม 2023 (3 ปี)  
- **Out-of-Sample (Test)**: มกราคม 2024 – ธันวาคม 2024 (1 ปี)  

---

## กลยุทธ์ที่ทดสอบ (4 กลุ่ม)

| กลุ่มกลยุทธ์      | การเลือกหุ้น                              | วิธีคำนวณพอร์ต                          |
|--------------------|--------------------------------------------|------------------------------------------|
| **AAA_MPT**        | เฉพาะหุ้นที่ได้คะแนน ESG ระดับ AAA (สูงสุด)   | Modern Portfolio Theory (MPT)            |
| **ESG_All_MPT**    | หุ้นทุกตัวที่มีคะแนน ESG (ทุกระดับ)         | Modern Portfolio Theory (MPT)            |
| **AAA_XGB**        | เฉพาะหุ้นระดับ AAA เท่านั้น                  | XGBoost (ทำนายผลตอบแทนล่วงหน้า) + ESG  |
| **ESG_All_XGB**    | หุ้นทุกตัวที่มีคะแนน ESG (ทุกระดับ)         | XGBoost (ทำนายผลตอบแทนล่วงหน้า) + ESG  |
---
## ขั้นตอนการทำ

1.  **ดาวน์โหลดและนำเข้า Library:** ติดตั้งและนำเข้าไลบรารีที่จำเป็น (`yfinance`, `scipy`, `pandas`, `numpy`, `matplotlib`, `xgboost`, `sklearn`)
2.  **โหลดข้อมูล ESG Score:** อ่านไฟล์ `esg-score.csv` เข้ามาใน DataFrame
3.  **สร้างรายการหุ้นตามเงื่อนไข:** กรองรายชื่อหุ้นที่ได้ ESG Rating 'AAA' และรายชื่อหุ้นทั้งหมดที่มี ESG Rating ในปี 2024
4.  **แปลงชื่อย่อหุ้น:** เติม `.BK` ต่อท้าย Ticker Symbol เพื่อให้สามารถดึงข้อมูลราคาจาก yfinance ได้
5.  **ดึงข้อมูลราคา:** ดาวน์โหลดข้อมูลราคาปิดแบบ Adjusted Close รายวัน สำหรับช่วง In-Sample (2021-2023) และ Out-of-Sample (2024)
6.  **เตรียมข้อมูลราคา:** ทำความสะอาดข้อมูลราคา โดยลบคอลัมน์ (หุ้น) ที่มีค่า NaN ในช่วงเวลาใดเวลาหนึ่งออก เพื่อให้มั่นใจว่ามีข้อมูลครบถ้วนสำหรับทุกหุ้นที่นำมาวิเคราะห์
7.  **คำนวณ Returns และ Covariance (In-Sample):** คำนวณผลตอบแทนรายวัน และ Covariance Matrix ของหุ้นแต่ละกลุ่มในช่วง In-Sample (ใช้สำหรับ MPT)
8.  **สร้างฟังก์ชัน MPT:** สร้างฟังก์ชันสำหรับคำนวณ Portfolio Performance (Return, Volatility, Sharpe Ratio) และฟังก์ชันสำหรับ Optimize หา Weights ที่ให้ Sharpe Ratio สูงสุด
9.  **ทำ Portfolio Optimization (MPT):** ใช้ฟังก์ชัน Optimize เพื่อหาน้ำหนักการลงทุนที่เหมาะสมสำหรับพอร์ต AAA และ ESG All ตามหลัก MPT โดยใช้ข้อมูล In-Sample
10. **เตรียมข้อมูลสำหรับ XGBoost:** รวมข้อมูลราคารายวันเป็นรายเดือน และคำนวณ Features (Momentum 3 เดือน, Momentum 6 เดือน, Volatility 3 เดือน) และ Target (ผลตอบแทนเดือนถัดไป) ในรูปแบบ Long Format สำหรับช่วง In-Sample (2021-2023)
11. **แบ่ง Train/Validation และเทรน XGBoost:** แบ่งข้อมูล In-Sample ออกเป็น Train และ Validation Set และเทรน XGBoost Model สำหรับกลุ่ม AAA และ ESG All เพื่อทำนายผลตอบแทนรายเดือน
12. **ทำ Backtesting (Out-of-Sample):** สร้างฟังก์ชันสำหรับ Backtest กลยุทธ์ XGBoost ในช่วงปี 2024 โดยทุกสิ้นเดือนจะใช้โมเดลที่เทรนแล้วทำนายหุ้นที่มีผลตอบแทนคาดว่าจะบวก และจัดพอร์ตแบบ Equal Weight (หรือตามสัดส่วน Pred > 0)
13. **คำนวณ Metrics และสรุปผล:** คำนวณ Metrics สำคัญ เช่น Total Return, Annualized Return, Volatility, Sharpe Ratio, Max Drawdown และ Final Value สำหรับทั้ง 4 กลยุทธ์ในช่วง Backtest (ปี 2024) และแสดงผลในรูปแบบตารางและกราฟเปรียบเทียบ Cumulative Return
---

## ผลการทดสอบ (Performance Metrics: ปี 2024)

| กลยุทธ์       | ผลตอบแทนรวม (Return) | ความผันผวน (Volatility) | ขาดทุนสูงสุด (Max Drawdown) | Sharpe Ratio* |
|---------------|----------------------|--------------------------|-----------------------------|---------------|
| **AAA_MPT**       | –6.75%               | 9.09%                    | –16.49%                     | –0.77         |
| **ESG_All_MPT**   | –7.77%               | 7.39%                    | –11.52%                     | –1.09         |
| **AAA_XGB**       | –35.32%              | 21.31%                   | –36.62%                     | –1.66         |
| **ESG_All_XGB**   | –11.38%              | 27.65%                   | –24.40%                     | –0.41         |

> **หมายเหตุ:**  
> *Sharpe Ratio คำนวณโดยใช้ Risk-Free Rate = 1% ต่อปี ยิ่งมากยิ่งดี (Sharpe Ratio = (Return – Risk-Free Rate) / Volatility)

---

## ข้อค้นพบที่สำคัญ (Key Findings)

1. **MPT + ESG ให้ผลลัพธ์เสถียรกว่า AI (XGBoost)**  
   - พอร์ต **AAA_MPT** และ **ESG_All_MPT** มีการขาดทุนน้อยกว่า (–6% ถึง –8%) และความผันผวนต่ำกว่า (7–9%)  
   - ขณะที่กลยุทธ์ **XGBoost + ESG** ขาดทุนสูง (–11% ถึง –35%) และความผันผวนสูงกว่า (21–27%)  

2. **ESG ช่วยลดความเสี่ยงได้เป็นรูปธรรม**  
   - พอร์ต **ESG_All_MPT** (ทุกหุ้นที่มีคะแนน ESG) มี Max Drawdown ต่ำสุด –11.52% เมื่อเทียบกับ **AAA_MPT** (–16.49%)  
   - แสดงให้เห็นว่า “การกระจายลงทุนในหุ้น ESG หลากหลาย” ดีกว่าการเลือกเฉพาะหุ้น AAA เพียงกลุ่มเดียว  

3. **ปัจจัยที่ทำให้ XGBoost ยังแพ้**  
   - **Overfitting**: โมเดล XGBoost จดจำรูปแบบในข้อมูล In-Sample ได้ดี แต่รับมือกับสภาวะตลาดใหม่ได้ไม่เพียงพอ  
   - **ไม่มีการกระจายความเสี่ยงเพียงพอ**: AI เลือกบนพื้นฐานการทำนายเป็นหลัก ไม่ได้คำนึงถึง “การกระจายความสัมพันธ์ระหว่างหุ้น” ในรูปแบบเดียวกับ MPT  
   - **ต้นทุนการซื้อขายสูง**: เนื่องจาก XGBoost เปลี่ยนหุ้นในพอร์ตบ่อย ต้นทุนค่า Commission และ Slippage จึงสูงขึ้น  

4. **กลยุทธ์ AAA_MPT ให้ผลตอบแทนตลอดช่วงทดสอบคุ้มค่าที่สุด**  
   - แม้ว่าผลตอบแทนจะติดลบเล็กน้อย แต่มีความผันผวนและ Max Drawdown ที่จัดการได้  
   - เหมาะสำหรับนักลงทุนที่เน้นการลดความเสี่ยงควบคู่ไปกับการคำนึงถึงหลักการ ESG  

---

## ข้อควรระวัง (Caveats)

* ผลการทดสอบนี้ใช้ข้อมูลในช่วง **2021–2024** เท่านั้น
* **ผลตอบแทนในอดีตไม่รับประกันผลตอบแทนในอนาคต**
* การคำนวณไม่รวมค่า Commission, Slippage หรือ Transaction Cost อื่น ๆ
* โปรดพิจารณาปรึกษาผู้เชี่ยวชาญด้านการลงทุนก่อนนำไปใช้งานจริง

---

## Dependencies

```text
yfinance          # ดึงข้อมูลราคาหุ้นย้อนหลัง
pandas            # จัดการและวิเคราะห์ข้อมูล
numpy             # คำนวณเชิงตัวเลข
matplotlib        # สร้างกราฟ Visualization
scipy             # คำนวณพารามิเตอร์ทางสถิติ
xgboost           # สร้างและเทรนโมเดล AI
scikit-learn      # เครื่องมือ ML พื้นฐาน (Train/Test Split, Metrics)
PyPortfolioOpt    # ช่วยคำนวณ Portfolio Optimization


